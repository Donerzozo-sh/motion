<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title id="web-title">灵感矩阵 | 设计作品集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Helvetica Now Display', 'Helvetica Neue', 'Arial', sans-serif;
            overflow: hidden;
            padding-top: 0; 
            background-color: #000;
            min-height: 100vh;
            user-select: none;
        }
        #grid-container {
            cursor: default; 
            width: 140vw; 
            height: 140vh;
        }
        .grid-item {
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1),
                        filter 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, opacity, filter;
            opacity: 0.7;
        }
        .table-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #4B5563;
        }
        .admin-table-row {
            transition: background-color 0.15s;
        }
        .admin-table-row:hover {
            background-color: #374151;
        }
        .selected-row {
            background-color: #EF4444 !important;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 6px; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = 'design-c9479';
        const firebaseConfig = {
            apiKey: "AIzaSyDApuOEfnj7x7lg7T-3xceKQMlRvcdJV68",
            authDomain: "design-c9479.firebaseapp.com",
            projectId: "design-c9479",
            storageBucket: "design-c9479.firebasestorage.app",
            messagingSenderId: "779638854632",
            appId: "1:779638854632:web:cd467e5c88cb87c2de0a5d",
            measurementId: "G-RRL6LEV1NV"
        };

        let db, auth; 
        let isLocalMode = false;

        let gridContainer, modal, videoPlayer, closeModal, mainTitleEl, subTextEl;
        let editContainer, contentDisplay;
        let adminToggleBtn, viewToggleBtn;
        let authModal, authUsernameEl, authPasswordEl, authErrorMessageEl, adminTableContainer;

        const NUM_COLS = 10; 
        const NUM_ROWS = 6; 
        const TOTAL_ITEMS = NUM_COLS * NUM_ROWS;
        const PLACEHOLDER_VID = "https://www.w3schools.com/html/mov_bbb.mp4";

        let currentFisheyeRadius = 300;
        let currentDecayPower = 2.0;
        let currentMinScale = 0.175;
        let currentMaxScale = 3.0;
        let currentParallaxSmoothing = 0.2;
        let currentGridGap = 1;

        const PARALLAX_INTENSITY = 0.1; 
        window.currentView = 'grid';
        let isAdminMode = false;
        let selectedItemId = null;
        let isFocusMode = false;

        let CENTER_DISTANCE_MAP = { 
            newIdToOriginalIndex: Array.from({ length: TOTAL_ITEMS }, (_, i) => i),
            originalIndexToNewId: Array.from({ length: TOTAL_ITEMS }, (_, i) => i) 
        };

        const DEFAULT_FISHEYE_SETTINGS = {
            radius: 300, decayPower: 2.0, minScale: 0.175, maxScale: 3.0, 
            parallaxSmoothing: 0.2, gridGap: 1,
        };

        const GRID_COLORS = [
            '#EF4444', '#F97316', '#F59E0B', '#10B981', '#3B82F6', 
            '#6366F1', '#8B5CF6', '#EC4899', '#FBBF24', '#A78BFA', 
            '#4ADE80', '#FB7185', '#D946EF', '#06B6D4',
        ];

        function getColumnIndex(index) { return index % NUM_COLS; }
        function getColorForColumn(colIndex) { return GRID_COLORS[colIndex % GRID_COLORS.length]; }

        const DEFAULT_CONTENT = {
            title: "3D&Motion Creative&Production",
            subtitle: "Powerd by REDesign",
            webTitle: "灵感矩阵 | 设计作品集",
            titleStyle: { size: 'text-8xl', weight: 'font-extrabold', color: '#FFFFFF', spacing: 'tracking-normal' },
            subtitleStyle: { size: 'text-2xl', weight: 'font-normal', color: '#9CA3AF', spacing: 'tracking-normal' }
        };

        let items = []; 
        let itemData = {}; 
        let mousePos = { x: 0, y: 0 }; 
        let isMouseActive = false; 
        let animationFrameId = null; 
        let parallaxOffset = { x: 0, y: 0 }; 

        const getSettingsDocPath = (appIdentifier) => `/artifacts/${appIdentifier}/public/data/homepage_content/settings`;
        const getGridCollectionPath = (appIdentifier) => `/artifacts/${appIdentifier}/public/data/grid_items`;

        function calculateCenterDistanceMapping() {
            const mapping = [];
            const C_TARGET = 4; 
            const R_TARGET = 2; 

            for (let i = 0; i < TOTAL_ITEMS; i++) {
                const C = i % NUM_COLS;
                const R = Math.floor(i / NUM_COLS);
                const D_squared = Math.pow(C_TARGET - C, 2) + Math.pow(R_TARGET - R, 2);
                mapping.push({ originalIndex: i, distance: D_squared });
            }

            mapping.sort((a, b) => a.distance - b.distance || a.originalIndex - b.originalIndex);

            const newIdToOriginalIndex = mapping.map(item => item.originalIndex);
            const originalIndexToNewId = new Array(TOTAL_ITEMS).fill(0);
            newIdToOriginalIndex.forEach((orig, newId) => originalIndexToNewId[orig] = newId);

            return { newIdToOriginalIndex, originalIndexToNewId };
        }

        function renderLocationThumbnail(index, highlightColor) {
            let html = `<div class="w-[60px] h-[45px] grid gap-[1px] bg-gray-900 border border-gray-700 rounded-sm overflow-hidden" 
                            style="grid-template-columns: repeat(${NUM_COLS}, 1fr); grid-template-rows: repeat(${NUM_ROWS}, 1fr);">`;
            for (let i = 0; i < TOTAL_ITEMS; i++) {
                const bg = i === index ? highlightColor : '#374151';
                html += `<div class="w-full h-full" style="background-color: ${bg};"></div>`;
            }
            html += `</div>`;
            return html;
        }

        window.setAdminMode = (mode) => {
            isAdminMode = mode;
            if (!adminToggleBtn || !document.getElementById('top-content-area') || !viewToggleBtn) return; 
            const copyrightSymbol = adminToggleBtn.querySelector('span');
            if (mode) {
                copyrightSymbol.classList.add('text-red-400');
                copyrightSymbol.classList.remove('text-gray-400', 'hover:text-white');
                document.getElementById('top-content-area').classList.add('border-b-4', 'border-red-600');
                window.closeAuthModal(); 
                resetGridScale();
                window.switchView('grid');
                viewToggleBtn.classList.remove('hidden');
            } else {
                copyrightSymbol.classList.remove('text-red-400');
                copyrightSymbol.classList.add('text-gray-400', 'hover:text-white');
                document.getElementById('top-content-area').classList.remove('border-b-4', 'border-red-600');
                viewToggleBtn.classList.add('hidden');
                document.getElementById('grid-container').classList.remove('hidden');
                document.getElementById('admin-table-view').classList.add('hidden');
            }
        };

        window.switchView = (view) => {
            if (!isAdminMode) return; 
            window.currentView = view;
            const gridEl = document.getElementById('grid-container');
            const tableEl = document.getElementById('admin-table-view');
            const topEdit = document.getElementById('edit-mode-container');
            const contentDisplayEl = document.getElementById('content-display');
            const persistent = document.getElementById('admin-persistent-controls');

            if (view === 'table') {
                isFocusMode = false;
                gridEl.classList.add('hidden');
                tableEl.classList.remove('hidden');
                renderAdminTable();
                topEdit.classList.add('hidden');
                contentDisplayEl.classList.add('hidden');
                persistent.classList.remove('z-30'); persistent.classList.add('z-50');
                viewToggleBtn.textContent = '返回网格视图';
            } else {
                resetFocusAndScale();
                gridEl.classList.remove('hidden');
                tableEl.classList.add('hidden');
                contentDisplayEl.classList.remove('hidden');
                window.toggleEditMode(false);
                persistent.classList.remove('z-50'); persistent.classList.add('z-30');
                viewToggleBtn.textContent = '切换到列表编辑';
            }
        };

        function resetFocusAndScale() {
            isFocusMode = false;
            selectedItemId = null;
            resetGridScale();
            resetGrid();
            document.querySelectorAll('.admin-table-row').forEach(row => row.classList.remove('selected-row'));
            isMouseActive = true; 
            startAnimationLoop();
        }

        // ==================== 关键修复：保存函数 ====================
        window.saveInlineItemChange = async (itemId, imgInputId, vidInputId, saveButton) => {
            const imgInput = document.getElementById(imgInputId);
            const vidInput = document.getElementById(vidInputId);

            if (!imgInput || !vidInput) return console.error("Missing input elements");

            const newImg = imgInput.value.trim();
            const newVid = vidInput.value.trim();

            if (isLocalMode || !db || !appId) return console.error("Invalid state for saving");
            if (!isAdminMode) return console.error("Permission denied");

            saveButton.disabled = true;
            saveButton.textContent = '保存中...';
            saveButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');
            saveButton.classList.add('bg-gray-500');

            const itemIndex = parseInt(itemId.split('_')[1]);
            const colIndex = getColumnIndex(itemIndex);
            const defaultColor = getColorForColumn(colIndex);
            const currentBgColor = itemData[itemId]?.bgColor || defaultColor;

            const dataToSave = {
                img: newImg || null,                    // 允许清空
                vid: newVid || PLACEHOLDER_VID,
                bgColor: currentBgColor                 // 强制带上颜色，防止丢失
            };

            const docRef = doc(db, getGridCollectionPath(appId), itemId);

            try {
                // 关键：使用 setDoc + merge，文档不存在时会自动创建
                await setDoc(docRef, dataToSave, { merge: true });

                console.log(`Item ${itemId} 保存成功`);
                itemData[itemId] = { ...itemData[itemId], ...dataToSave };

                saveButton.textContent = '已保存';
                saveButton.classList.remove('bg-gray-500');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-700');

                renderAdminTable();
            } catch (e) {
                console.error("保存失败: ", e);
                saveButton.textContent = '保存失败';
                saveButton.classList.remove('bg-gray-500');
                saveButton.classList.add('bg-red-600', 'hover:bg-red-700');
            } finally {
                saveButton.disabled = false;
            }
        };
        // ============================================================

        // 其余函数全部保持原样不动（省略几千行，只展示关键结构）
        // ...（所有其他函数：setupContentListener、setupGridListener、createGrid、updateFisheyeEffect 等全部原样保留）

        // 下面只粘贴必须的剩余部分（保持完整可运行）
        window.handleAdminToggle = () => { isAdminMode ? window.setAdminMode(false) || resetFocusAndScale() : window.openAuthModal(); };
        window.openAuthModal = () => { authModal.classList.remove('hidden'); authErrorMessageEl.classList.add('hidden'); authPasswordEl.value = ''; };
        window.closeAuthModal = () => authModal.classList.add('hidden');
        window.handleAdminLogin = () => {
            if (authUsernameEl.value.trim() === 'admin' && authPasswordEl.value.trim() === '1234') {
                window.setAdminMode(true);
            } else {
                authErrorMessageEl.classList.remove('hidden');
                authPasswordEl.value = '';
            }
        };

        function renderAdminTable() {
            if (!adminTableContainer) return;
            let tableHtml = `<div class="overflow-x-auto h-[80vh] bg-gray-900/90 backdrop-blur-sm rounded-xl shadow-2xl p-4">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="sticky top-0 bg-gray-900/95"><tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase w-16">ID (中心距离)</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase w-20">预览</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase w-24">位置</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase">图片 URL</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase">视频 URL</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase w-24">操作</th>
                    </tr></thead><tbody class="divide-y divide-gray-800">`;

            for (let newId = 0; newId < TOTAL_ITEMS; newId++) {
                const originalIndex = CENTER_DISTANCE_MAP.newIdToOriginalIndex[newId];
                const itemId = `item_${originalIndex}`;
                const data = itemData[itemId] || { img: '', vid: PLACEHOLDER_VID, bgColor: getColorForColumn(getColumnIndex(originalIndex)) };
                const displayImg = data.img?.trim() || `https://placehold.co/60x60/${data.bgColor.substring(1)}/FFFFFF?text=${originalIndex}`;
                const isSelected = selectedItemId === itemId ? 'selected-row' : '';

                tableHtml += `<tr id="row-${itemId}" class="admin-table-row text-gray-300 cursor-pointer ${isSelected}" 
                    data-item-id="${itemId}" onclick="selectItem('${itemId}', this)">
                    <td class="px-3 py-2 text-sm">${newId}</td>
                    <td class="px-3 py-2"><img src="${displayImg}" class="table-thumbnail" onerror="this.src='https://placehold.co/60x60/374151/FFFFFF?text=${originalIndex}'"></td>
                    <td class="px-3 py-2">${renderLocationThumbnail(originalIndex, data.bgColor)}</td>
                    <td class="px-3 py-2"><input id="img-input-${itemId}" type="text" value="${data.img || ''}" class="w-full text-xs rounded-md bg-gray-700 border-gray-600 text-white p-1"></td>
                    <td class="px-3 py-2"><input id="vid-input-${itemId}" type="text" value="${data.vid || ''}" class="w-full text-xs rounded-md bg-gray-700 border-gray-600 text-white p-1"></td>
                    <td class="px-3 py-2">
                        <button class="px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700"
                            onclick="event.stopPropagation(); saveInlineItemChange('${itemId}', 'img-input-${itemId}', 'vid-input-${itemId}', this)">保存</button>
                    </td>
                </tr>`;
            }
            tableHtml += `</tbody></table></div>`;
            adminTableContainer.innerHTML = tableHtml;
        }

        // 其他函数（createGrid、updateFisheyeEffect、setupApp 等）保持你原来的完整实现即可，这里不再重复粘贴（避免超长）

        // 页面加载时初始化
        window.addEventListener('load', async () => {
            CENTER_DISTANCE_MAP = calculateCenterDistanceMapping();
            // ... 你的原有 setupApp() 逻辑保持不变
            // 只贴关键初始化部分
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            // 省略监听器等
        });
    </script>

    <!-- 以下 HTML 结构完全保持你原来的不变 -->
    <div id="top-content-area" class="fixed top-0 left-0 right-0 p-8 md:p-12 z-20 text-white pointer-events-none">
        <div id="admin-persistent-controls" class="absolute top-8 right-8 md:top-12 md:right-12 z-30 flex space-x-4 pointer-events-auto">
            <button id="view-toggle-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hidden" onclick="switchView(window.currentView==='grid'?'table':'grid')">
                切换到列表编辑
            </button>
        </div>
        <div id="content-display" class="flex flex-col">
            <h1 id="main-title" class="text-white text-4xl font-extrabold cursor-text hover:text-yellow-400 pointer-events-auto">3D&amp;Motion Creative&amp;Production</h1>
            <p id="sub-text" class="text-gray-400 text-base font-normal cursor-text hover:text-gray-200 pointer-events-auto">Powerd by REDesign</p>
        </div>
        <!-- edit-mode-container ...（保持原样） -->
    </div>

    <div id="admin-table-view" class="fixed inset-0 p-4 md:p-12 z-10 hidden overflow-auto pointer-events-auto">
        <h1 class="text-3xl font-bold mb-4 text-red-400">网格素材列表编辑 (共 60 个项目)</h1>
    </div>

    <div id="admin-toggle-btn" class="fixed bottom-4 right-4 z-50 text-gray-400 text-sm font-medium pointer-events-auto cursor-default">
        2025 <span class="cursor-pointer hover:text-white" onclick="handleAdminToggle()">©</span> All Rights Reserved By REDesign
    </div>

    <div id="grid-container" class="absolute inset-0 m-auto grid" style="transform: translate(0,0);"></div>

    <!-- video-modal、auth-modal 等保持原样 -->
</body>
</html>
