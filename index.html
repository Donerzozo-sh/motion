<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title id="web-title">çµæ„ŸçŸ©é˜µ | è®¾è®¡ä½œå“é›†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¼ºåˆ¶ä½¿ç”¨ Helvetica Now Display å­—ä½“ï¼Œå¹¶æä¾›ç³»ç»Ÿå›é€€ */
        body {
            font-family: 'Helvetica Now Display', 'Helvetica Neue', 'Arial', sans-serif;
            /* éšè—æ»šåŠ¨æ¡ï¼Œæ‰“é€ åº”ç”¨æ„Ÿ */
            overflow: hidden;
            padding-top: 0; 
            background-color: #000;
            min-height: 100vh;
            user-select: none;
        }

        #grid-container {
            cursor: default; 
            /* ä¿æŒè¾ƒå¤§çš„å®¹å™¨å°ºå¯¸ä»¥å…è®¸é±¼çœ¼æ•ˆæœæ”¾å¤§ */
            width: 140vw; 
            height: 140vh;
        }

        .grid-item {
            /* å…³é”®ï¼šç¨å¾®å¢åŠ è¿‡æ¸¡æ—¶é—´ (0.1s -> 0.15s) ä»¥æå‡è§†è§‰å¹³æ»‘æ„Ÿ */
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1),
                        filter 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            
            will-change: transform, opacity, filter;
            opacity: 0.7;
        }
        
        /* ç®¡ç†è¡¨æ ¼ä¸­çš„ç¼©ç•¥å›¾æ ·å¼ */
        .table-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #4B5563;
        }
        
        .admin-table-row {
            transition: background-color 0.15s;
        }

        .admin-table-row:hover {
            background-color: #374151; /* hover:bg-gray-700 */
        }
        
        .selected-row {
            background-color: #EF4444 !important; /* bg-red-500 */
        }

        /* éšè—åŸç”Ÿé¢œè‰²é€‰æ‹©å™¨çš„è¾“å…¥æ¡† */
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // å¯¼å…¥ updateDoc ç”¨äºå†…è”ç¼–è¾‘
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==============================================================================
        // ** ã€ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®é…ç½®åŒºåŸŸï¼šæ‰‹åŠ¨é…ç½® Firebase Firestore ğŸ”¥ğŸ”¥ğŸ”¥ã€‘ **
        // ==============================================================================
        
        // 1. åº”ç”¨ ID (é‡è¦ï¼šç”¨äºæ„å»º Firestore è·¯å¾„)
        const appId = 'design-c9479'; 

        // 2. Firebase é…ç½®å¯¹è±¡ (å·²æ›¿æ¢ä¸ºæ‚¨çš„çœŸå®é…ç½®)
        const firebaseConfig = {
            apiKey: "AIzaSyDApuOEfnj7x7lg7T-3xceKQMlRvcdJV68",
            authDomain: "design-c9479.firebaseapp.com",
            projectId: "design-c9479",
            storageBucket: "design-c9479.firebasestorage.app",
            messagingSenderId: "779638854632",
            appId: "1:779638854632:web:cd467e5c88cb87c2de0a5d",
            measurementId: "G-RRL6LEV1NV"
        };
        
        // 3. åˆå§‹èº«ä»½éªŒè¯ä»¤ç‰Œ (åœ¨ GitHub Pages/Vercel ç¯å¢ƒä¸­ä¿æŒ null å³å¯ï¼Œå¼ºåˆ¶åŒ¿åç™»å½•)
        const initialAuthToken = null; 
        
        // ==============================================================================
        // ** é…ç½®ç»“æŸ **
        // ==============================================================================

        // --- Firebase & State Variables ---
        let db, auth; 
        let isLocalMode = false;

        // --- DOM å…ƒç´ å£°æ˜ ---
        let gridContainer, modal, videoPlayer, closeModal, mainTitleEl, subTextEl;
        let editContainer, contentDisplay, editTitleEl, editSubtitleEl, topContentArea;
        let editWebTitleEl, editTitleSizeEl, editTitleWeightEl, editTitleColorPickerEl, editTitleSpacingEl;
        let editSubtitleSizeEl, editSubtitleWeightEl, editSubtitleColorPickerEl, editSubtitleSpacingEl;
        let adminToggleBtn, viewToggleBtn;
        let authModal, authUsernameEl, authPasswordEl, authErrorMessageEl, adminTableContainer;
        
        // ** è§†è§‰å‚æ•°ç¼–è¾‘å…ƒç´  **
        let editFisheyeRadiusEl, editDecayPowerEl, editMinScaleEl, editMaxScaleEl;
        let editParallaxSmoothingEl; 
        let editGridGapEl; // ã€æ–°å¢ã€‘ç½‘æ ¼é—´è·å…ƒç´ 


        // --- é…ç½®/çŠ¶æ€å˜é‡ ---
        const NUM_COLS = 10; 
        const NUM_ROWS = 6; 
        const TOTAL_ITEMS = NUM_COLS * NUM_ROWS; // 60
        const PLACEHOLDER_VID = "https://www.w3schools.com/html/mov_bbb.mp4"; // é»˜è®¤è§†é¢‘å ä½ç¬¦

        // ** åŠ¨æ€äº¤äº’å‚æ•° **
        let currentFisheyeRadius = 300;
        let currentDecayPower = 2.0; // é±¼çœ¼è¡°å‡å¹…åº¦ (æŒ‡æ•°)
        let currentMinScale = 0.175; // åˆå§‹å¤§å°
        let currentMaxScale = 3.0; // æœ€å¤§æ”¾å¤§å€æ•°
        let currentParallaxSmoothing = 0.2; // ã€åŠ¨æ€ã€‘å¹³æ»‘åº¦å‚æ•° (å›æ»šåçš„é»˜è®¤å€¼)
        let currentGridGap = 1; // ã€æ–°å¢ã€‘ç½‘æ ¼é—´è· (px)

        // å›ºå®šçš„è§†å·®å¼ºåº¦
        const PARALLAX_INTENSITY = 0.1; 
        
        // ã€æ–°å¢çŠ¶æ€å˜é‡ã€‘
        window.currentView = 'grid'; // 'grid' | 'table'
        let isAdminMode = false;
        let selectedItemId = null; // å½“å‰åœ¨è¡¨æ ¼ä¸­é€‰ä¸­çš„ Item ID
        let isFocusMode = false; // æ˜¯å¦å¤„äºèšç„¦æ¨¡å¼
        
        // ã€æ–°å¢ã€‘ä¸­å¿ƒè·ç¦»æ’åºæ˜ å°„
        let CENTER_DISTANCE_MAP = { 
            newIdToOriginalIndex: Array.from({ length: TOTAL_ITEMS }, (_, i) => i), // é»˜è®¤åˆå§‹åŒ–
            originalIndexToNewId: Array.from({ length: TOTAL_ITEMS }, (_, i) => i) 
        };


        const DEFAULT_FISHEYE_SETTINGS = {
            radius: 300,
            decayPower: 2.0,
            minScale: 0.175,
            maxScale: 3.0, 
            parallaxSmoothing: 0.2, // å¹³æ»‘åº¦é»˜è®¤å€¼
            gridGap: 1, // ã€æ–°å¢ã€‘é»˜è®¤ç½‘æ ¼é—´è·
        };

        const GRID_COLORS = [
            '#EF4444', '#F97316', '#F59E0B', '#10B981', '#3B82F6', 
            '#6366F1', '#8B5CF6', '#EC4899', '#FBBF24', '#A78BFA', 
            '#4ADE80', '#FB7185', '#D946EF', '#06B6D4', 
        ];

        function getColumnIndex(index) {
            return index % NUM_COLS;
        }

        function getColorForColumn(colIndex) {
            return GRID_COLORS[colIndex % GRID_COLORS.length];
        }


        const DEFAULT_CONTENT = {
            title: "3D&Motion Creative&Production",
            subtitle: "Powerd by REDesign",
            webTitle: "çµæ„ŸçŸ©é˜µ | è®¾è®¡ä½œå“é›†",
            titleStyle: { size: 'text-8xl', weight: 'font-extrabold', color: '#FFFFFF', spacing: 'tracking-normal' },
            subtitleStyle: { size: 'text-2xl', weight: 'font-normal', color: '#9CA3AF', spacing: 'tracking-normal' }
        };

        let items = []; 
        let itemData = {}; 
        let mousePos = { x: 0, y: 0 }; 
        let isMouseActive = false; 
        let animationFrameId = null; 
        let parallaxOffset = { x: 0, y: 0 }; 
        let editingItemId = null; 

        // ä½¿ç”¨ç¡¬ç¼–ç çš„ appId æ¥æ„å»º Firestore è·¯å¾„
        const getSettingsDocPath = (appIdentifier) => `/artifacts/${appIdentifier}/public/data/homepage_content/settings`;
        const getGridCollectionPath = (appIdentifier) => `/artifacts/${appIdentifier}/public/data/grid_items`;


        // --- æ ·å¼è¾…åŠ©å‡½æ•° (ä¿æŒä¸å˜) ---

        function applyTextStyles(element, styleData, isTitle) {
            if (!element) return; 

            const prefixesToClear = [
                'text-', 'font-', 'tracking-' 
            ];
            
            element.className = element.className.split(' ').filter(c => 
                !prefixesToClear.some(prefix => c.startsWith(prefix))
            ).join(' ');

            if (styleData.size) element.classList.add(styleData.size);
            if (styleData.weight) element.classList.add(styleData.weight);
            if (styleData.spacing) element.classList.add(styleData.spacing);
            
            element.style.color = styleData.color || (isTitle ? '#FFFFFF' : '#9CA3AF');

            if (isTitle) {
                element.classList.add('mb-4', 'transition-colors', 'duration-500', 'hover:text-yellow-400', 'cursor-text');
                element.classList.add('md:text-8xl'); 
            } else {
                element.classList.add('transition-colors', 'duration-500', 'hover:text-gray-200', 'cursor-text');
                element.classList.add('md:text-2xl'); 
            }
        }
        
        /**
         * ã€æ–°å¢å‡½æ•°ã€‘è®¡ç®—ç½‘æ ¼ä¸­å¿ƒè·ç¦»æ’åºæ˜ å°„
         * @returns {{newIdToOriginalIndex: number[], originalIndexToNewId: number[]}} æ˜ å°„å¯¹è±¡
         */
        function calculateCenterDistanceMapping() {
            const mapping = [];
            // 10x6 ç½‘æ ¼çš„ä¸­å¿ƒç‚¹ (C, R) æ˜¯ (4.5, 2.5)
            // é¡¹ç›®ä¸­å¿ƒ (C_item, R_item) æ˜¯ (C+0.5, R+0.5)
            // è·ç¦»å¹³æ–¹ D^2 = (4.5 - (C+0.5))^2 + (2.5 - (R+0.5))^2 = (4-C)^2 + (2-R)^2
            const C_TARGET = 4; 
            const R_TARGET = 2; 

            for (let i = 0; i < TOTAL_ITEMS; i++) {
                const C = i % NUM_COLS;
                const R = Math.floor(i / NUM_COLS);

                const D_squared = Math.pow(C_TARGET - C, 2) + Math.pow(R_TARGET - R, 2);

                // Store the original index (spatial index) and its distance score
                mapping.push({ originalIndex: i, distance: D_squared, C, R });
            }

            // Sort by distance (ascending). Distance 0 is the closest (i=24).
            // Use original index as secondary key for stable sorting
            mapping.sort((a, b) => {
                if (a.distance !== b.distance) {
                    return a.distance - b.distance; 
                }
                return a.originalIndex - b.originalIndex; 
            });

            // Create the final index map: new ID -> original index
            const newIdToOriginalIndex = mapping.map(item => item.originalIndex);
            
            // Create the reverse map: original index -> new ID
            const originalIndexToNewId = new Array(TOTAL_ITEMS).fill(0);
            newIdToOriginalIndex.forEach((originalIndex, newId) => {
                originalIndexToNewId[originalIndex] = newId;
            });

            return { newIdToOriginalIndex, originalIndexToNewId };
        }


        /**
         * ã€æ–°å¢å‡½æ•°ã€‘ç”Ÿæˆç½‘æ ¼ä½ç½®ç¼©ç•¥å›¾ HTML
         * @param {number} index - å½“å‰é¡¹ç›®åœ¨ç½‘æ ¼ä¸­çš„åŸå§‹ç©ºé—´ç´¢å¼• (0 to TOTAL_ITEMS - 1).
         * @param {string} highlightColor - ç”¨äºé«˜äº®çš„é¢œè‰² (å³é¡¹ç›®çš„ bgColor).
         * @returns {string} HTML string for the thumbnail grid.
         */
        function renderLocationThumbnail(index, highlightColor) {
            const totalItems = NUM_COLS * NUM_ROWS; 
            // è®¾å®šå›ºå®šçš„å°ºå¯¸ (60px x 45px)ï¼Œgap ä¸º 1px
            let gridHtml = `<div class="w-[60px] h-[45px] grid gap-[1px] bg-gray-900 border border-gray-700 rounded-sm overflow-hidden" 
                                style="grid-template-columns: repeat(${NUM_COLS}, 1fr); grid-template-rows: repeat(${NUM_ROWS}, 1fr);">`;

            for (let i = 0; i < totalItems; i++) {
                // å½“å‰é¡¹ç›®ä½¿ç”¨å…¶è‡ªèº«çš„ bgColorï¼Œå…¶ä»–é¡¹ç›®ä½¿ç”¨æš—ç°è‰² #374151
                const bgColor = i === index ? highlightColor : '#374151'; 
                gridHtml += `<div class="w-full h-full" style="background-color: ${bgColor};"></div>`;
            }

            gridHtml += `</div>`;
            return gridHtml;
        }


        // --- Admin/Auth é€»è¾‘ ---

        window.setAdminMode = (mode) => {
            isAdminMode = mode;
            if (!adminToggleBtn || !topContentArea || !viewToggleBtn) return; 

            // è·å–ç‰ˆæƒä¿¡æ¯ä¸­çš„Â©ç¬¦å·å…ƒç´ 
            const copyrightSymbol = adminToggleBtn.querySelector('span');
            
            if (mode) {
                // ON: é«˜äº®Â©ç¬¦å·ä¸ºçº¢è‰²
                copyrightSymbol.classList.add('text-red-400');
                copyrightSymbol.classList.remove('text-gray-400', 'hover:text-white');
                topContentArea.classList.add('border-b-4', 'border-red-600');
                window.closeAuthModal(); 
                
                // ** è¿›å…¥ç®¡ç†å‘˜æ¨¡å¼æ—¶ï¼Œç«‹å³å¤ä½ç½‘æ ¼ç¼©æ”¾çŠ¶æ€ **
                resetGridScale();
                console.log("Admin Mode activated. Grid scales reset.");
                
                // é»˜è®¤åˆ‡æ¢åˆ°ç½‘æ ¼è§†å›¾ï¼Œå¹¶æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
                window.switchView('grid');
                viewToggleBtn.classList.remove('hidden'); // æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®

            } else {
                // OFF: æ¢å¤Â©ç¬¦å·ä¸ºé»˜è®¤ç°è‰²
                copyrightSymbol.classList.remove('text-red-400');
                copyrightSymbol.classList.add('text-gray-400', 'hover:text-white');
                topContentArea.classList.remove('border-b-4', 'border-red-600');
                viewToggleBtn.classList.add('hidden'); // éšè—åˆ‡æ¢æŒ‰é’®
                console.log("Admin Mode deactivated.");
                
                // ç¡®ä¿è¿”å›ç½‘æ ¼è§†å›¾
                document.getElementById('grid-container').classList.remove('hidden');
                document.getElementById('admin-table-view').classList.add('hidden');
            }
        };
        
        /**
         * åˆ‡æ¢è§†å›¾ï¼šç½‘æ ¼ <-> è¡¨æ ¼
         */
        window.switchView = (view) => {
            if (!isAdminMode) return; 

            window.currentView = view; // ä½¿ç”¨ window.currentView

            const gridEl = document.getElementById('grid-container');
            const tableEl = document.getElementById('admin-table-view');
            const topEditContainer = document.getElementById('edit-mode-container');
            const contentDisplayEl = document.getElementById('content-display');
            const persistentControlsEl = document.getElementById('admin-persistent-controls');

            if (view === 'table') {
                isFocusMode = false; // è¿›å…¥è¡¨æ ¼æ¨¡å¼ï¼Œé€€å‡ºèšç„¦
                gridEl.classList.add('hidden');
                tableEl.classList.remove('hidden');
                renderAdminTable(); // ç”Ÿæˆè¡¨æ ¼å†…å®¹
                
                // éšè—ä¸»æ ‡é¢˜ç¼–è¾‘é¢æ¿å’Œä¸»æ ‡é¢˜æ˜¾ç¤º
                topEditContainer.classList.add('hidden'); 
                contentDisplayEl.classList.add('hidden');
                
                // ç¡®ä¿ç®¡ç†å‘˜æ§åˆ¶æ¡æ˜¾ç¤ºåœ¨æœ€é¡¶å±‚
                persistentControlsEl.classList.remove('z-30');
                persistentControlsEl.classList.add('z-50'); 
                
                viewToggleBtn.textContent = 'è¿”å›ç½‘æ ¼è§†å›¾';
            } else {
                // åˆ‡æ¢å›ç½‘æ ¼è§†å›¾æ—¶ï¼Œé‡ç½®èšç„¦/ç¼©æ”¾
                resetFocusAndScale(); 
                gridEl.classList.remove('hidden');
                tableEl.classList.add('hidden');
                
                // åˆ‡æ¢å›ç½‘æ ¼è§†å›¾æ—¶ï¼Œæ˜¾ç¤ºä¸»æ ‡é¢˜
                contentDisplayEl.classList.remove('hidden');
                window.toggleEditMode(false); // ç¡®ä¿è®¾ç½®é¢æ¿æŠ˜å 
                
                persistentControlsEl.classList.remove('z-50');
                persistentControlsEl.classList.add('z-30');
                
                viewToggleBtn.textContent = 'åˆ‡æ¢åˆ°åˆ—è¡¨ç¼–è¾‘';
            }
        };
        
        /**
         * é‡ç½®èšç„¦å’Œç¼©æ”¾
         */
        function resetFocusAndScale() {
            isFocusMode = false;
            selectedItemId = null;
            resetGridScale(); // å¤ä½ç½‘æ ¼å…ƒç´ å¤§å°
            resetGrid(); // å¤ä½ç½‘æ ¼åç§»
            
            // ç§»é™¤æ‰€æœ‰è¡Œé«˜äº®
            document.querySelectorAll('.admin-table-row').forEach(row => {
                row.classList.remove('selected-row');
            });

            // æ¢å¤é¼ æ ‡åŠ¨ç”»
            isMouseActive = true; 
            startAnimationLoop();
        }


        window.handleAdminToggle = () => {
            if (!adminToggleBtn) return; 
            if (isAdminMode) {
                window.setAdminMode(false);
                resetFocusAndScale(); // é€€å‡ºç®¡ç†å‘˜æ¨¡å¼æ—¶é‡ç½®æ‰€æœ‰çŠ¶æ€
            } else {
                window.openAuthModal();
            }
        };

        window.openAuthModal = () => {
            if (!authModal || !authErrorMessageEl || !authPasswordEl) return; 

            authErrorMessageEl.classList.add('hidden'); 
            // ç§»é™¤è‡ªåŠ¨å¡«å……å¯†ç ï¼Œæ”¹ä¸ºæ¸…ç©º
            authPasswordEl.value = ''; 
            authUsernameEl.value = 'admin'; // ä¿ç•™ç”¨æˆ·åå¡«å……
            authModal.classList.remove('hidden');
        };

        window.closeAuthModal = () => {
            if (!authModal) return; 
            authModal.classList.add('hidden');
        };

        window.handleAdminLogin = () => {
            if (!authUsernameEl || !authPasswordEl || !authErrorMessageEl) return; 

            const username = authUsernameEl.value.trim();
            const password = authPasswordEl.value.trim();
            
            const correctUsername = 'admin';
            const correctPassword = '1234'; 

            if (username === correctUsername && password === correctPassword) {
                window.setAdminMode(true);
            } else {
                authErrorMessageEl.classList.remove('hidden');
                authPasswordEl.value = ''; // ç™»å½•å¤±è´¥æ—¶æ¸…ç©ºå¯†ç 
            }
        };

        /**
         * åˆ‡æ¢ç¼–è¾‘æ¨¡å¼ (é¡¶éƒ¨æ–‡æœ¬ & è§†è§‰å‚æ•°)
         */
        window.toggleEditMode = (enable) => {
            if (!isAdminMode || !editContainer || !contentDisplay || !mainTitleEl || !subTextEl) {
                return; 
            }
            
            if (enable) {
                const titleStyle = mainTitleEl.dataset.style ? JSON.parse(mainTitleEl.dataset.style) : DEFAULT_CONTENT.titleStyle;
                const subtitleStyle = subTextEl.dataset.style ? JSON.parse(subTextEl.dataset.style) : DEFAULT_CONTENT.subtitleStyle;

                // å¡«å……ç½‘ç«™åç§°
                // ã€æ³¨ã€‘DEFAULT_CONTENT.webTitle æ˜¯æ—§çš„ï¼Œåº”è¯¥ä» <title> æ ‡ç­¾è·å–å½“å‰å€¼
                editWebTitleEl.value = document.getElementById('web-title').textContent;

                // å¡«å……æ–‡æœ¬å†…å®¹
                editTitleEl.value = mainTitleEl.textContent;
                editSubtitleEl.value = subTextEl.textContent;

                // å¡«å……ä¸»æ ‡é¢˜æ ·å¼
                editTitleSizeEl.value = titleStyle.size;
                editTitleWeightEl.value = titleStyle.weight;
                editTitleColorPickerEl.value = titleStyle.color;
                editTitleSpacingEl.value = titleStyle.spacing;

                // å¡«å……å‰¯æ ‡é¢˜æ ·å¼
                editSubtitleSizeEl.value = subtitleStyle.size;
                editSubtitleWeightEl.value = subtitleStyle.weight;
                editSubtitleColorPickerEl.value = subtitleStyle.color;
                editSubtitleSpacingEl.value = subtitleStyle.spacing;
                
                // ** å¡«å……è§†è§‰å‚æ•° **
                editFisheyeRadiusEl.value = currentFisheyeRadius;
                editDecayPowerEl.value = currentDecayPower;
                editMinScaleEl.value = currentMinScale;
                editMaxScaleEl.value = currentMaxScale; 
                editParallaxSmoothingEl.value = currentParallaxSmoothing; // å¡«å……å¹³æ»‘åº¦
                editGridGapEl.value = currentGridGap; // ã€æ–°å¢ã€‘å¡«å……ç½‘æ ¼é—´è·
                

                contentDisplay.classList.add('hidden');
                editContainer.classList.remove('hidden');
            } else {
                contentDisplay.classList.remove('hidden');
                editContainer.classList.add('hidden');
            }
        };

        /**
         * ä¿å­˜å†…å®¹åˆ° Firestore (é¡¶éƒ¨æ–‡æœ¬ & è§†è§‰å‚æ•°)
         */
        window.saveContent = async () => {
            if (!editWebTitleEl || !editTitleEl || !editSubtitleEl || !editFisheyeRadiusEl) {
                return console.error("Missing edit elements. Cannot save."); 
            }

            const newWebTitle = editWebTitleEl.value.trim(); 
            const newTitle = editTitleEl.value.trim();
            const newSubtitle = editSubtitleEl.value.trim();

            if (isLocalMode || !db || !appId) return console.error("Firestore is not initialized. Cannot save in local mode. Please check Firebase config.");
            if (!isAdminMode) return console.error("Permission denied. Admin mode required.");

            const docRef = doc(db, getSettingsDocPath(appId));
            
            const newTitleStyle = {
                size: editTitleSizeEl.value,
                weight: editTitleWeightEl.value,
                color: editTitleColorPickerEl.value,
                spacing: editTitleSpacingEl.value,
            };

            const newSubtitleStyle = {
                size: editSubtitleSizeEl.value,
                weight: editSubtitleWeightEl.value,
                color: editSubtitleColorPickerEl.value,
                spacing: editSubtitleSpacingEl.value,
            };
            
            // ** æ”¶é›†æ–°çš„è§†è§‰å‚æ•° (åŒ…æ‹¬å¹³æ»‘åº¦å’Œç½‘æ ¼é—´è·) **
            const newFisheyeSettings = {
                radius: parseFloat(editFisheyeRadiusEl.value) || DEFAULT_FISHEYE_SETTINGS.radius,
                decayPower: parseFloat(editDecayPowerEl.value) || DEFAULT_FISHEYE_SETTINGS.decayPower,
                minScale: parseFloat(editMinScaleEl.value) || DEFAULT_FISHEYE_SETTINGS.minScale,
                maxScale: parseFloat(editMaxScaleEl.value) || DEFAULT_FISHEYE_SETTINGS.maxScale, 
                parallaxSmoothing: parseFloat(editParallaxSmoothingEl.value) || DEFAULT_FISHEYE_SETTINGS.parallaxSmoothing, // æ”¶é›†å¹³æ»‘åº¦
                gridGap: parseInt(editGridGapEl.value) || DEFAULT_FISHEYE_SETTINGS.gridGap, // ã€æ–°å¢ã€‘æ”¶é›†ç½‘æ ¼é—´è·
            };

            try {
                // ã€ä¿®å¤ã€‘ä½¿ç”¨ setDoc(..., { merge: true }) æ¥ç¡®ä¿ settings æ–‡æ¡£åœ¨ä¸å­˜åœ¨æ—¶èƒ½è¢«åˆ›å»º
                await setDoc(docRef, {
                    webTitle: newWebTitle || DEFAULT_CONTENT.webTitle, 
                    title: newTitle || DEFAULT_CONTENT.title,
                    subtitle: newSubtitle || DEFAULT_CONTENT.subtitle,
                    titleStyle: newTitleStyle,
                    subtitleStyle: newSubtitleStyle,
                    fisheyeSettings: newFisheyeSettings, // ä¿å­˜åŒ…å«å¹³æ»‘åº¦å’Œç½‘æ ¼é—´è·çš„æ–°è§†è§‰å‚æ•°
                    timestamp: new Date()
                }, { merge: true }); // ä½¿ç”¨ merge: true
                
                console.log("Content and Settings saved successfully.");
                window.toggleEditMode(false);
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        };

        /**
         * æœ¬åœ°å›é€€é€»è¾‘ï¼šå¦‚æœæ— æ³•è¿æ¥ Firebaseï¼Œåˆ™ä½¿ç”¨é»˜è®¤æ•°æ®å¹¶ç«‹å³æ¸²æŸ“ã€‚
         */
        window.runLocalFallback = () => {
            if (!mainTitleEl || !subTextEl || !gridContainer) {
                 console.error("Critical DOM elements not found for fallback.");
                 return;
            }
            isLocalMode = true;
            console.warn("Firebase connection failed. Running in Local Mode (Read-Only) with default data.");
            
            // ç«‹å³åº”ç”¨é»˜è®¤å†…å®¹
            document.title = DEFAULT_CONTENT.webTitle; 
            mainTitleEl.textContent = DEFAULT_CONTENT.title;
            subTextEl.textContent = DEFAULT_CONTENT.subtitle;
            applyTextStyles(mainTitleEl, DEFAULT_CONTENT.titleStyle, true);
            applyTextStyles(subTextEl, DEFAULT_CONTENT.subtitleStyle, false);
            
            // åº”ç”¨é»˜è®¤è§†è§‰å‚æ•°
            currentFisheyeRadius = DEFAULT_FISHEYE_SETTINGS.radius;
            currentDecayPower = DEFAULT_FISHEYE_SETTINGS.decayPower;
            currentMinScale = DEFAULT_FISHEYE_SETTINGS.minScale;
            currentMaxScale = DEFAULT_FISHEYE_SETTINGS.maxScale;
            currentParallaxSmoothing = DEFAULT_FISHEYE_SETTINGS.parallaxSmoothing; // åº”ç”¨é»˜è®¤å¹³æ»‘åº¦
            currentGridGap = DEFAULT_FISHEYE_SETTINGS.gridGap; // åº”ç”¨é»˜è®¤ç½‘æ ¼é—´è·

            // åˆå§‹åŒ–ä¸­å¿ƒè·ç¦»æ˜ å°„
            CENTER_DISTANCE_MAP = calculateCenterDistanceMapping();

            // åˆå§‹åŒ–ç½‘æ ¼æ•°æ®å¹¶æ¸²æŸ“
            initializeDefaultGridData(); 
            createGrid(); 
            startAnimationLoop(); 
            window.setAdminMode(false); // ç¡®ä¿åœ¨å›é€€æ¨¡å¼ä¸‹ä¹Ÿåº”ç”¨æ­£ç¡®çš„æŒ‰é’®æ ·å¼
        };


        /**
         * ç›‘å¬ Firestore ä¸Šçš„å†…å®¹å˜åŒ–
         */
        window.setupContentListener = (firestore, appIdentifier) => {
            if (!mainTitleEl || !subTextEl) return; 
            
            const docRef = doc(firestore, getSettingsDocPath(appIdentifier)); 

            onSnapshot(docRef, (docSnap) => {
                let data = {};
                if (docSnap.exists()) {
                    data = docSnap.data();
                } else {
                    // å¦‚æœ settings æ–‡æ¡£ä¸å­˜åœ¨ï¼Œä¹Ÿä½¿ç”¨é»˜è®¤å€¼
                    console.warn("Settings document does not exist. Using default content.");
                }

                // --- 1. æ›´æ–°é¡¶éƒ¨æ–‡æœ¬å’Œæ ·å¼ ---
                const currentWebTitle = data.webTitle || DEFAULT_CONTENT.webTitle; 
                const currentTitle = data.title || DEFAULT_CONTENT.title;
                const currentSubtitle = data.subtitle || DEFAULT_CONTENT.subtitle;
                const currentTitleStyle = data.titleStyle || DEFAULT_CONTENT.titleStyle;
                const currentSubtitleStyle = data.subtitleStyle || DEFAULT_CONTENT.subtitleStyle;

                document.title = currentWebTitle; 
                mainTitleEl.textContent = currentTitle;
                subTextEl.textContent = currentSubtitle;

                applyTextStyles(mainTitleEl, currentTitleStyle, true);
                applyTextStyles(subTextEl, currentSubtitleStyle, false);

                mainTitleEl.dataset.style = JSON.stringify(currentTitleStyle);
                subTextEl.dataset.style = JSON.stringify(currentSubtitleStyle);

                // --- 2. æ›´æ–°è§†è§‰å‚æ•° ---
                const settings = data.fisheyeSettings || DEFAULT_FISHEYE_SETTINGS;
                currentFisheyeRadius = settings.radius;
                currentDecayPower = settings.decayPower;
                currentMinScale = settings.minScale;
                currentMaxScale = settings.maxScale || DEFAULT_FISHEYE_SETTINGS.maxScale; 
                currentParallaxSmoothing = settings.parallaxSmoothing || DEFAULT_FISHEYE_SETTINGS.parallaxSmoothing; // æ›´æ–°å¹³æ»‘åº¦
                currentGridGap = settings.gridGap || DEFAULT_FISHEYE_SETTINGS.gridGap; // ã€æ–°å¢ã€‘æ›´æ–°ç½‘æ ¼é—´è·
                
                // ç¡®ä¿ç½‘æ ¼æ›´æ–°åˆå§‹å¤§å°å’Œé—´è·
                updateGridDOM();

            }, (error) => {
                console.error("Error listening to content:", error);
            });
        };

        /**
         * ç›‘å¬ Firestore ä¸Šçš„ç½‘æ ¼é¡¹ç›®å˜åŒ–
         */
        window.setupGridListener = (firestore, appIdentifier) => {
            if (!gridContainer) return; 
            
            const colRef = collection(firestore, getGridCollectionPath(appIdentifier)); 

            onSnapshot(colRef, (snapshot) => {
                let initialLoad = Object.keys(itemData).length === 0;
                
                // ä»…åœ¨éé¦–æ¬¡åŠ è½½æ—¶å¤„ç†å˜åŒ–
                if (!initialLoad) {
                     snapshot.docChanges().forEach(change => {
                        const data = change.doc.data();
                        const itemId = change.doc.id;
                        const i = parseInt(itemId.split('_')[1]); // åŸå§‹ç©ºé—´ç´¢å¼•
                        
                        if (i >= TOTAL_ITEMS) return; // å¿½ç•¥è¶…å‡ºèŒƒå›´çš„
                        
                        const colIndex = getColumnIndex(i);
                        const defaultColor = getColorForColumn(colIndex);

                        // æ›´æ–° itemData ç¼“å­˜
                        itemData[itemId] = {
                            img: data.img || null, 
                            vid: data.vid || PLACEHOLDER_VID,
                            bgColor: data.bgColor || defaultColor 
                        };
                    });
                } else {
                    // é¦–æ¬¡åŠ è½½ï¼šæ„å»ºå®Œæ•´ç¼“å­˜
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const itemId = doc.id;
                        const i = parseInt(itemId.split('_')[1]);
                        
                        if (i >= TOTAL_ITEMS) return; 

                        const colIndex = getColumnIndex(i);
                        const defaultColor = getColorForColumn(colIndex);
                        
                        itemData[itemId] = {
                            img: data.img || null, 
                            vid: data.vid || PLACEHOLDER_VID,
                            bgColor: data.bgColor || defaultColor 
                        };
                    });
                }

                
                // å¡«å……æ‰€æœ‰ç¼ºå¤±çš„é¡¹ç›®ï¼Œç¡®ä¿ itemData æ€»æ˜¯åŒ…å« TOTAL_ITEMS (60) ä¸ªé”®
                for (let i = 0; i < TOTAL_ITEMS; i++) {
                    const itemId = `item_${i}`;
                    const colIndex = getColumnIndex(i);
                    const defaultColor = getColorForColumn(colIndex);
                    
                    if (!itemData[itemId]) {
                        // ä½¿ç”¨é»˜è®¤æ•°æ®è¿›è¡Œå¡«å……
                        itemData[itemId] = {
                            img: null,
                            vid: PLACEHOLDER_VID,
                            bgColor: defaultColor
                        };
                    }
                }


                if (initialLoad) {
                    createGrid();
                } else {
                    updateGridDOM();
                    // å¦‚æœåœ¨è¡¨æ ¼è§†å›¾ä¸‹ï¼Œå®æ—¶åˆ·æ–°è¡¨æ ¼
                    if (window.currentView === 'table') {
                        renderAdminTable();
                    }
                }
            }, async (error) => {
                console.error("Error listening to grid items:", error);
                // ç›‘å¬å¤±è´¥æ—¶ï¼ˆä¾‹å¦‚æƒé™é—®é¢˜ï¼‰ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°å›é€€
                if (Object.keys(itemData).length === 0) {
                    // æ³¨æ„ï¼šè¿™é‡Œä¸åº”è¯¥è°ƒç”¨ initializeDefaultGridDataï¼Œå› ä¸ºå®ƒä¼šå°è¯•å†™å…¥
                    // è€Œæ˜¯åº”è¯¥ç›´æ¥å¡«å……æœ¬åœ° itemData å¹¶åˆ›å»ºç½‘æ ¼
                    console.warn("Grid listener failed. Populating with local defaults (read-only).");
                    for (let i = 0; i < TOTAL_ITEMS; i++) {
                        const itemId = `item_${i}`;
                        const colIndex = getColumnIndex(i);
                        itemData[itemId] = {
                            img: null,
                            vid: PLACEHOLDER_VID,
                            bgColor: getColorForColumn(colIndex)
                        };
                    }
                    createGrid();
                }
            });
        };
        
        /**
         * åˆå§‹åŒ–é»˜è®¤ç½‘æ ¼æ•°æ® (æœ¬åœ°æ¨¡å¼ä¸‹ä¸å†™å…¥ DB)
         */
        async function initializeDefaultGridData() {
            if (!gridContainer) return; 

            if (isLocalMode) {
                for (let i = 0; i < TOTAL_ITEMS; i++) {
                    const itemId = `item_${i}`;
                    const colIndex = getColumnIndex(i);
                    itemData[itemId] = {
                        img: null,
                        vid: PLACEHOLDER_VID,
                        bgColor: getColorForColumn(colIndex)
                    };
                }
                return; 
            }

            if (!db || !appId) return console.error("Firestore DB/App ID not ready for default initialization.");

            const colRef = collection(db, getGridCollectionPath(appId));
            const snapshot = await getDocs(colRef);

            if (snapshot.empty) {
                console.log("No existing grid data. Initializing default items.");
                for (let i = 0; i < TOTAL_ITEMS; i++) {
                    const itemId = `item_${i}`;
                    const colIndex = getColumnIndex(i);
                    const defaultColor = getColorForColumn(colIndex);

                    itemData[itemId] = {
                        img: null, 
                        vid: PLACEHOLDER_VID,
                        bgColor: defaultColor
                    };
                    // ã€ä¿®æ”¹ã€‘ä¸å†åªå†™å…¥å‰5ä¸ªï¼Œè€Œæ˜¯æŒ‰éœ€å†™å…¥ï¼ˆåœ¨ handleGridItemUpdate ä¸­å¤„ç†ï¼‰
                    // if (i < 5) { 
                    //    await setDoc(doc(db, getGridCollectionPath(appId), itemId), itemData[itemId]);
                    // }
                }
                 // é¢å¤–å†™å…¥ä¸€ä¸ª settings æ–‡æ¡£ï¼Œé˜²æ­¢ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ä¹Ÿæ˜¯ç©ºçš„
                 await setDoc(doc(db, getSettingsDocPath(appId)), DEFAULT_CONTENT, { merge: true });
                 console.log("Default settings document created.");
                 
            } else {
                 // å¦‚æœå­˜åœ¨æ•°æ®ï¼Œä½†æ•°é‡ä¸è¶³ TOTAL_ITEMSï¼Œç¡®ä¿ itemData å®Œæ•´
                 snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const i = parseInt(doc.id.split('_')[1]); // åŸå§‹ç©ºé—´ç´¢å¼•
                    // å¿½ç•¥è¶…å‡ºæ–° TOTAL_ITEMS èŒƒå›´çš„é¡¹ç›®
                    if (i >= TOTAL_ITEMS) return; 
                    
                    const colIndex = getColumnIndex(i);
                    const defaultColor = getColorForColumn(colIndex);

                    itemData[doc.id] = {
                        img: data.img || null,
                        vid: data.vid || PLACEHOLDER_VID,
                        bgColor: data.bgColor || defaultColor
                    };
                });
                 // å¡«å……ç¼ºå¤±çš„éƒ¨åˆ†
                 for (let i = 0; i < TOTAL_ITEMS; i++) {
                     const itemId = `item_${i}`;
                     if (!itemData[itemId]) {
                          const colIndex = getColumnIndex(i);
                          itemData[itemId] = { img: null, vid: PLACEHOLDER_VID, bgColor: getColorForColumn(colIndex) };
                     }
                 }
            }
        }
        
        function createGrid() {
            if (items.length > 0 || !gridContainer) return; 
            
            gridContainer.innerHTML = ''; 
            // ç½‘æ ¼ç»“æ„ä¿æŒä¸å˜ï¼ˆ10x6ï¼‰
            gridContainer.style.gridTemplateColumns = `repeat(${NUM_COLS}, 1fr)`;
            // ã€æ–°å¢ã€‘è®¾ç½®ç½‘æ ¼é—´è·
            gridContainer.style.gap = `${currentGridGap}px`;

            for (let i = 0; i < TOTAL_ITEMS; i++) {
                // i æ˜¯åŸå§‹çš„ç©ºé—´ç´¢å¼• (0-59, ä»å·¦ä¸Šè§’å¼€å§‹)
                const itemId = `item_${i}`;
                const data = itemData[itemId] || { // ç¡®ä¿æœ‰é»˜è®¤æ•°æ®
                    img: null,
                    vid: PLACEHOLDER_VID,
                    bgColor: getColorForColumn(getColumnIndex(i))
                };

                const item = document.createElement('div');
                item.className = 'grid-item aspect-square bg-cover bg-center cursor-pointer';
                
                // åº”ç”¨æ•°æ® (é¢œè‰²/å›¾ç‰‡)
                if (data.img && data.img.trim()) {
                    item.style.backgroundImage = `url(${data.img})`;
                    item.style.backgroundColor = 'transparent';
                } else {
                    item.style.backgroundImage = 'none';
                    item.style.backgroundColor = data.bgColor;
                }
                
                // è®¾ç½®åˆå§‹ç¼©æ”¾
                item.style.transform = `scale(${currentMinScale})`;

                item.dataset.index = i; // å­˜å‚¨åŸå§‹ç©ºé—´ç´¢å¼•
                item.dataset.itemid = itemId; // å­˜å‚¨ Item ID

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ (æ— è®ºæ˜¯å¦åœ¨ç®¡ç†æ¨¡å¼ä¸‹)
                item.addEventListener('click', () => handleItemClick(item, data));

                gridContainer.appendChild(item);
                items.push(item);
            }
        }
        
        /**
         * ä»…æ›´æ–° DOM å…ƒç´ çš„æ ·å¼ (å›¾ç‰‡ã€é¢œè‰²ã€é—´è·ã€åˆå§‹ç¼©æ”¾)
         * ä¸é‡æ–°åˆ›å»º DOM å…ƒç´ 
         */
        function updateGridDOM() {
            if (items.length === 0 || !gridContainer) {
                 if (items.length === 0 && Object.keys(itemData).length > 0) {
                     // å¦‚æœ DOM æœªåˆ›å»ºä½†æ•°æ®å·²åŠ è½½ï¼Œåˆ™åˆ›å»º
                     createGrid();
                 }
                 return;
            }
            
            // æ›´æ–°ç½‘æ ¼é—´è·
            gridContainer.style.gap = `${currentGridGap}px`;
            
            for (let i = 0; i < TOTAL_ITEMS; i++) {
                const item = items[i];
                if (!item) continue; 
                
                const itemId = item.dataset.itemid;
                const data = itemData[itemId];
                
                if (!data) continue; // æ•°æ®å¯èƒ½å°šæœªåŠ è½½

                // 1. æ›´æ–°èƒŒæ™¯ (å›¾ç‰‡æˆ–é¢œè‰²)
                if (data.img && data.img.trim()) {
                    item.style.backgroundImage = `url(${data.img})`;
                    item.style.backgroundColor = 'transparent';
                } else {
                    item.style.backgroundImage = 'none';
                    item.style.backgroundColor = data.bgColor;
                }
                
                // 2. æ›´æ–°åŸºç¡€ç¼©æ”¾ (å¦‚æœä¸åœ¨èšç„¦æ¨¡å¼ä¸‹)
                if (!isFocusMode) {
                     item.style.transform = `scale(${currentMinScale})`;
                }
            }
        }


        // --- äº¤äº’ä¸åŠ¨ç”» ---

        function handleItemClick(item, data) {
            if (isAdminMode && window.currentView === 'grid') {
                // ã€ç®¡ç†æ¨¡å¼ä¸‹çš„æ–°äº¤äº’ã€‘
                const itemId = item.dataset.itemid;
                
                if (isFocusMode && selectedItemId === itemId) {
                    // å¦‚æœå†æ¬¡ç‚¹å‡»å·²èšç„¦çš„é¡¹ç›®ï¼Œå–æ¶ˆèšç„¦
                    resetFocusAndScale();
                } else {
                    // å¦åˆ™ï¼Œèšç„¦åˆ°è¿™ä¸ªé¡¹ç›®
                    focusOnItem(itemId);
                }
                
            } else if (isAdminMode && window.currentView === 'table') {
                // åœ¨è¡¨æ ¼è§†å›¾ä¸‹ï¼Œç‚¹å‡»ç½‘æ ¼æ— æ•ˆ
                return;
            } else {
                // ã€è®¿å®¢æ¨¡å¼ã€‘æ‰“å¼€è§†é¢‘æ’­æ”¾å™¨
                openModal(data.vid);
            }
        }
        
        /**
         * ã€æ–°å¢ã€‘èšç„¦åˆ°ç‰¹å®šé¡¹ç›®
         */
        function focusOnItem(itemId) {
            if (!gridContainer || items.length === 0) return;
            
            selectedItemId = itemId;
            isFocusMode = true;
            isMouseActive = false; // åœæ­¢é¼ æ ‡åŠ¨ç”»å¾ªç¯
            
            // 1. è®¡ç®—ç›®æ ‡å…ƒç´ 
            const targetItem = items.find(el => el.dataset.itemid === itemId);
            if (!targetItem) {
                console.warn(`Item ${itemId} not found in DOM.`);
                return resetFocusAndScale();
            }
            
            const targetRect = targetItem.getBoundingClientRect();
            const gridRect = gridContainer.getBoundingClientRect();

            // 2. è®¡ç®—ç½‘æ ¼éœ€è¦ç§»åŠ¨çš„åç§»é‡ï¼Œä½¿ç›®æ ‡é¡¹ç›®å±…ä¸­
            // è§†å£ä¸­å¿ƒ
            const viewportCenterX = window.innerWidth / 2;
            const viewportCenterY = window.innerHeight / 2;
            
            // ç›®æ ‡é¡¹ç›®ä¸­å¿ƒ (ç›¸å¯¹äº gridContainer)
            const itemCenterX_grid = targetItem.offsetLeft + targetRect.width / 2;
            const itemCenterY_grid = targetItem.offsetTop + targetRect.height / 2;

            // ç½‘æ ¼å½“å‰åç§»
            const currentGridTx = parallaxOffset.x * (gridRect.width - window.innerWidth) * PARALLAX_INTENSITY;
            const currentGridTy = parallaxOffset.y * (gridRect.height - window.innerHeight) * PARALLAX_INTENSITY;

            // ç›®æ ‡åç§»é‡ (è®¡ç®—é€»è¾‘ç®€åŒ–)
            // ç›®æ ‡ï¼š (gridLeft + itemCenter_X) + TargetTx = viewportCenter_X
            // TargetTx = viewportCenter_X - gridRect.left - itemCenterX_grid
            
            // æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ transformï¼Œæ‰€ä»¥è®¡ç®— target transform
            // (gridRect.width / 2) æ˜¯ç½‘æ ¼çš„ä¸­å¿ƒ
            // (itemCenterX_grid - (gridRect.width / 2)) æ˜¯é¡¹ç›®ä¸­å¿ƒç›¸å¯¹äºç½‘æ ¼ä¸­å¿ƒçš„åç§»
            // æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªåç§»é‡ç§»åŠ¨åˆ°è§†å£ä¸­å¿ƒï¼ˆå³ 0,0ï¼Œå› ä¸ºç½‘æ ¼å·²ç» transform-translate -50% äº†ï¼‰
            
            const targetTx = (gridRect.width / 2) - itemCenterX_grid;
            const targetTy = (gridRect.height / 2) - itemCenterY_grid;
            
            // 3. åº”ç”¨ç½‘æ ¼å®¹å™¨çš„ transform (ä½¿å…¶å±…ä¸­)
            // æ³¨æ„ï¼šæˆ‘ä»¬ä¸å†ä½¿ç”¨ parallaxOffsetï¼Œè€Œæ˜¯ç›´æ¥è®¾ç½® transform
            gridContainer.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            gridContainer.style.transform = `translate(-50%, -50%) translate(${targetTx}px, ${targetTy}px) scale(1)`; // scale(1) ç§»é™¤è§†å·®çš„ç¼©æ”¾æ„Ÿ

            // 4. ç¼©æ”¾æ‰€æœ‰ç½‘æ ¼é¡¹
            items.forEach(item => {
                if (item.dataset.itemid === itemId) {
                    // ç›®æ ‡é¡¹ç›®ï¼šæ”¾å¤§
                    item.style.transform = `scale(${currentMaxScale})`;
                    item.style.opacity = '1';
                    item.style.filter = 'brightness(1)';
                    item.style.zIndex = '50';
                } else {
                    // å…¶ä»–é¡¹ç›®ï¼šç¼©å°åˆ°æ¶ˆå¤±
                    item.style.transform = 'scale(0)';
                    item.style.opacity = '0';
                    item.style.filter = 'brightness(0.5)';
                    item.style.zIndex = '1';
                }
            });
            
            // 5. é«˜äº®å¯¹åº”çš„è¡¨æ ¼è¡Œ (å¦‚æœè¡¨æ ¼å·²æ¸²æŸ“)
            highlightTableRow(itemId, true);
        }

        /**
         * ä»…é‡ç½®ç½‘æ ¼ç¼©æ”¾ï¼ˆç”¨äºé€€å‡º Admin æ¨¡å¼ï¼‰
         */
        function resetGridScale() {
            items.forEach(item => {
                item.style.transform = `scale(${currentMinScale})`;
                item.style.opacity = '0.7';
                item.style.filter = 'brightness(0.8)';
                item.style.zIndex = '1';
            });
        }
        
        /**
         * é‡ç½®ç½‘æ ¼åç§»ï¼ˆç”¨äºé€€å‡ºèšç„¦æ¨¡å¼ï¼‰
         */
        function resetGrid() {
            if (!gridContainer) return;
            // æ¢å¤è§†å·®åŠ¨ç”»æ‰€éœ€çš„ transform
            gridContainer.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            // è®¡ç®—å½“å‰çš„è§†å·®åç§»
            const tx = parallaxOffset.x * (gridContainer.clientWidth - window.innerWidth) * PARALLAX_INTENSITY;
            const ty = parallaxOffset.y * (gridContainer.clientHeight - window.innerHeight) * PARALLAX_INTENSITY;
            gridContainer.style.transform = `translate(-50%, -50%) translate(${tx}px, ${ty}px) scale(1)`;
        }


        function openModal(vidUrl) {
            if (!modal || !videoPlayer) return; 
            
            videoPlayer.src = vidUrl || PLACEHOLDER_VID;
            modal.classList.remove('hidden');
            
            // æš‚åœé±¼çœ¼åŠ¨ç”»
            isMouseActive = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }

        window.closeVideoModal = () => {
            if (!modal || !videoPlayer) return; 
            
            videoPlayer.pause();
            videoPlayer.src = '';
            modal.classList.add('hidden');
            
            // æ¢å¤é±¼çœ¼åŠ¨ç”»
            if (!isFocusMode) {
                isMouseActive = true;
                startAnimationLoop();
            }
        }

        function updateMousePos(e) {
            if (!isMouseActive) return;
            mousePos.x = e.clientX;
            mousePos.y = e.clientY;
        }

        function startAnimationLoop() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            function loop() {
                if (isMouseActive && window.currentView === 'grid' && !isFocusMode) {
                    updateGrid();
                    updateParallax();
                }
                animationFrameId = requestAnimationFrame(loop);
            }
            loop();
        }

        function updateGrid() {
            if (items.length === 0) return;

            items.forEach(item => {
                const rect = item.getBoundingClientRect();
                const dx = rect.left + rect.width / 2 - mousePos.x;
                const dy = rect.top + rect.height / 2 - mousePos.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                let scale;
                if (dist < currentFisheyeRadius) {
                    // ä½¿ç”¨æŒ‡æ•°è¡°å‡ (decay power)
                    const normalizedDist = dist / currentFisheyeRadius; // 0 (center) to 1 (edge)
                    const proximity = 1 - Math.pow(normalizedDist, currentDecayPower); // 1 (center) to 0 (edge)
                    scale = currentMinScale + (currentMaxScale - currentMinScale) * proximity;
                } else {
                    scale = currentMinScale;
                }

                const opacity = 0.7 + (scale - currentMinScale) / (currentMaxScale - currentMinScale) * 0.3;
                const brightness = 0.8 + (scale - currentMinScale) / (currentMaxScale - currentMinScale) * 0.2;

                item.style.transform = `scale(${scale})`;
                item.style.opacity = opacity;
                item.style.filter = `brightness(${brightness})`;
                item.style.zIndex = dist < currentFisheyeRadius ? '10' : '1';
            });
        }
        
        // ä½¿ç”¨ Lerp (çº¿æ€§æ’å€¼) æ¥å¹³æ»‘è§†å·®
        let smoothedParallax = { x: 0, y: 0 };

        function updateParallax() {
            if (!gridContainer) return;

            // 1. è®¡ç®—ç›®æ ‡åç§» (å½’ä¸€åŒ–åˆ° -0.5 åˆ° 0.5)
            const targetX = (mousePos.x / window.innerWidth) - 0.5;
            const targetY = (mousePos.y / window.innerHeight) - 0.5;

            // 2. ä½¿ç”¨ Lerp è¿›è¡Œå¹³æ»‘
            // lerp(start, end, amt) = (1 - amt) * start + amt * end
            const smoothing = 1 - currentParallaxSmoothing; // 0.2 çš„è®¾ç½®å€¼ -> 0.8 çš„æ’å€¼ç³»æ•°
            smoothedParallax.x = (smoothing * smoothedParallax.x) + ((1 - smoothing) * targetX);
            smoothedParallax.y = (smoothing * smoothedParallax.y) + ((1 - smoothing) * targetY);
            
            // 3. åº”ç”¨å¹³æ»‘åçš„åç§»
            parallaxOffset.x = smoothedParallax.x;
            parallaxOffset.y = smoothedParallax.y;

            const containerWidth = gridContainer.clientWidth;
            const containerHeight = gridContainer.clientHeight;
            
            if (containerWidth === 0 || containerHeight === 0) return; // é˜²æ­¢é™¤é›¶

            const offsetX = parallaxOffset.x * (containerWidth - window.innerWidth) * PARALLAX_INTENSITY;
            const offsetY = parallaxOffset.y * (containerHeight - window.innerHeight) * PARALLAX_INTENSITY;

            gridContainer.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px) scale(1)`;
        }


        // --- Admin Table é€»è¾‘ ---
        
        /**
         * æ¸²æŸ“ Admin è¡¨æ ¼
         */
        function renderAdminTable() {
            if (!adminTableContainer) return;
            
            let tableHtml = '';
            
            // éå†æ’åºåçš„ ID (0 to 59, æŒ‰ä¸­å¿ƒè·ç¦»)
            for (let newId = 0; newId < TOTAL_ITEMS; newId++) {
                
                // 1. æ ¹æ®æ–° ID (ä¸­å¿ƒè·ç¦») æ‰¾åˆ°åŸå§‹ç©ºé—´ç´¢å¼•
                const originalIndex = CENTER_DISTANCE_MAP.newIdToOriginalIndex[newId];
                
                // 2. æ ¹æ®åŸå§‹ç´¢å¼•è·å–é¡¹ç›®æ•°æ®
                const itemId = `item_${originalIndex}`;
                const data = itemData[itemId];
                
                if (!data) {
                    console.warn(`Data missing for item ${itemId} (New ID: ${newId})`);
                    continue;
                }
                
                const imgSrc = (data.img && data.img.trim()) ? data.img : '';
                const vidSrc = (data.vid === PLACEHOLDER_VID) ? '' : data.vid;
                
                // æ£€æŸ¥å½“å‰è¡Œæ˜¯å¦è¢«é€‰ä¸­
                const isSelected = (itemId === selectedItemId);
                
                tableHtml += `
                    <tr class="admin-table-row ${isSelected ? 'selected-row' : ''}" 
                        data-itemid="${itemId}" 
                        data-newid="${newId}"
                        onclick="window.handleTableRowClick('${itemId}')">
                        
                        <td class="px-4 py-2 text-sm text-gray-300 font-medium">${newId}</td>
                        
                        <td class="px-4 py-2">
                            ${renderLocationThumbnail(originalIndex, data.bgColor)}
                        </td>
                        
                        <td class="px-4 py-2">
                            ${imgSrc 
                                ? `<img src="${imgSrc}" class="table-thumbnail">` 
                                : `<div class="table-thumbnail" style="background-color: ${data.bgColor};"></div>`
                            }
                        </td>
                        
                        <td class="px-4 py-2">
                            <input type="text" value="${imgSrc}" 
                                   class="w-full px-2 py-1 bg-gray-900 border border-gray-600 rounded text-gray-200 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Image URL"
                                   data-field="img"
                                   onkeydown="window.handleAdminInputKeydown(event, '${itemId}', 'img')">
                        </td>
                        
                        <td class="px-4 py-2">
                            <input type="text" value="${vidSrc}" 
                                   class="w-full px-2 py-1 bg-gray-900 border border-gray-600 rounded text-gray-200 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Video URL"
                                   data-field="vid"
                                   onkeydown="window.handleAdminInputKeydown(event, '${itemId}', 'vid')">
                        </td>
                        
                        <td class="px-4 py-2">
                            <div class="relative w-16 h-8 flex items-center justify-center rounded border border-gray-600 bg-gray-900 overflow-hidden">
                                <input type="color" value="${data.bgColor}" 
                                       class="absolute inset-0 w-full h-full cursor-pointer p-0 border-none"
                                       data-field="bgColor"
                                       oninput="window.handleColorChange(event, '${itemId}', 'bgColor')">
                                <span class="text-xs text-gray-300 font-mono pointer-events-none uppercase">${data.bgColor.substring(1)}</span>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            adminTableContainer.innerHTML = tableHtml;
        }

        /**
         * å¤„ç†è¡¨æ ¼è¾“å…¥æ¡†çš„æŒ‰é”® (Enter ä¿å­˜, Esc å–æ¶ˆ)
         */
        window.handleAdminInputKeydown = (e, itemId, field) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const newValue = e.target.value.trim();
                
                // å¦‚æœæ˜¯ vid å­—æ®µä¸”è¾“å…¥ä¸ºç©ºï¼Œåˆ™å­˜å…¥å ä½ç¬¦
                if (field === 'vid' && newValue === '') {
                     window.handleGridItemUpdate(itemId, field, PLACEHOLDER_VID);
                } else {
                     window.handleGridItemUpdate(itemId, field, newValue);
                }
                
                e.target.blur(); // å¤±å»ç„¦ç‚¹
            } else if (e.key === 'Escape') {
                // æ¢å¤åŸå§‹å€¼
                const data = itemData[itemId];
                if (field === 'img') {
                    e.target.value = (data.img && data.img.trim()) ? data.img : '';
                } else if (field === 'vid') {
                    e.target.value = (data.vid === PLACEHOLDER_VID) ? '' : data.vid;
                }
                e.target.blur(); // å¤±å»ç„¦ç‚¹
            }
        };
        
        /**
         * å¤„ç†é¢œè‰²é€‰æ‹©å™¨å˜åŒ– (å®æ—¶ä¿å­˜)
         */
        window.handleColorChange = (e, itemId, field) => {
            const newValue = e.target.value;
            // æ›´æ–°æ—è¾¹çš„ HEX æ–‡æœ¬
            e.target.nextElementSibling.textContent = newValue.substring(1);
            // å®æ—¶ä¿å­˜
            window.handleGridItemUpdate(itemId, field, newValue);
        };
        
        /**
         * å¤„ç†è¡¨æ ¼è¡Œç‚¹å‡»
         */
        window.handleTableRowClick = (itemId) => {
            if (selectedItemId === itemId) {
                // å¦‚æœç‚¹å‡»äº†å·²é€‰ä¸­çš„è¡Œï¼Œå–æ¶ˆé€‰ä¸­å¹¶è¿”å›ç½‘æ ¼è§†å›¾
                selectedItemId = null;
                highlightTableRow(itemId, false); // å–æ¶ˆé«˜äº®
                window.switchView('grid'); // è¿”å›ç½‘æ ¼è§†å›¾
                resetFocusAndScale();
            } else {
                // é€‰ä¸­æ–°è¡Œ
                selectedItemId = itemId;
                highlightTableRow(itemId, true); // é«˜äº®æ–°è¡Œ
                
                // åˆ‡æ¢åˆ°ç½‘æ ¼è§†å›¾å¹¶èšç„¦
                window.switchView('grid');
                focusOnItem(itemId);
            }
        };

        /**
         * é«˜äº®è¡¨æ ¼è¡Œ (è¾…åŠ©å‡½æ•°)
         */
        function highlightTableRow(itemId, highlight) {
            document.querySelectorAll('.admin-table-row').forEach(row => {
                if (row.dataset.itemid === itemId) {
                    if (highlight) {
                        row.classList.add('selected-row');
                        // æ»šåŠ¨åˆ°è§†å›¾
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        row.classList.remove('selected-row');
                    }
                } else if (highlight) {
                    row.classList.remove('selected-row'); // ç§»é™¤å…¶ä»–è¡Œçš„é«˜äº®
                }
            });
        }
        
        /**
         * ã€é‡è¦ä¿®å¤ã€‘å¤„ç†è¡¨æ ¼é¡¹æ›´æ–° (ä½¿ç”¨ setDoc æ›¿ä»£ updateDoc)
         */
        window.handleGridItemUpdate = async (itemId, field, value) => {
            if (isLocalMode || !db || !appId) return console.error("Firestore is not initialized. Cannot save in local mode.");
            if (!isAdminMode) return console.error("Permission denied. Admin mode required.");

            const docRef = doc(db, getGridCollectionPath(appId), itemId);
            const updateData = {};
            updateData[field] = value;
            updateData['timestamp'] = new Date();

            try {
                // ã€é‡è¦ä¿®å¤ã€‘
                // ä½¿ç”¨ setDoc å’Œ { merge: true } æ¥ä»£æ›¿ updateDoc
                // è¿™å°†â€œåˆ›å»ºâ€ä¸€ä¸ªæ–°æ–‡æ¡£ï¼ˆå¦‚æœå®ƒä¸å­˜åœ¨ï¼‰ï¼Œæˆ–è€…â€œåˆå¹¶æ›´æ–°â€ä¸€ä¸ªæ—§æ–‡æ¡£
                await setDoc(docRef, updateData, { merge: true }); 
                
                console.log(`Item ${itemId} updated/created successfully. Field: ${field}, Value: ${value}`);
            } catch (e) {
                console.error(`Error saving grid item: `, e); 
            }
        };


        // --- åˆå§‹åŒ– ---

        document.addEventListener('DOMContentLoaded', async () => {
            // ç¼“å­˜ DOM å…ƒç´ 
            gridContainer = document.getElementById('grid-container');
            modal = document.getElementById('video-modal');
            videoPlayer = document.getElementById('video-player');
            closeModal = document.getElementById('close-modal-btn');
            mainTitleEl = document.getElementById('main-title');
            subTextEl = document.getElementById('sub-text');
            topContentArea = document.getElementById('top-content');

            // ç¼“å­˜ç¼–è¾‘é¢æ¿å…ƒç´ 
            editContainer = document.getElementById('edit-mode-container');
            contentDisplay = document.getElementById('content-display');
            editWebTitleEl = document.getElementById('edit-web-title');
            editTitleEl = document.getElementById('edit-title');
            editSubtitleEl = document.getElementById('edit-subtitle');
            
            // ç¼“å­˜ä¸»æ ‡é¢˜æ ·å¼å…ƒç´ 
            editTitleSizeEl = document.getElementById('edit-title-size');
            editTitleWeightEl = document.getElementById('edit-title-weight');
            editTitleColorPickerEl = document.getElementById('edit-title-color');
            editTitleSpacingEl = document.getElementById('edit-title-spacing');
            
            // ç¼“å­˜å‰¯æ ‡é¢˜æ ·å¼å…ƒç´ 
            editSubtitleSizeEl = document.getElementById('edit-subtitle-size');
            editSubtitleWeightEl = document.getElementById('edit-subtitle-weight');
            editSubtitleColorPickerEl = document.getElementById('edit-subtitle-color');
            editSubtitleSpacingEl = document.getElementById('edit-subtitle-spacing');

            // ç¼“å­˜è§†è§‰å‚æ•°å…ƒç´ 
            editFisheyeRadiusEl = document.getElementById('edit-fisheye-radius');
            editDecayPowerEl = document.getElementById('edit-decay-power');
            editMinScaleEl = document.getElementById('edit-min-scale');
            editMaxScaleEl = document.getElementById('edit-max-scale');
            editParallaxSmoothingEl = document.getElementById('edit-parallax-smoothing');
            editGridGapEl = document.getElementById('edit-grid-gap'); // ã€æ–°å¢ã€‘

            // ç¼“å­˜ Admin å…ƒç´ 
            adminToggleBtn = document.getElementById('admin-toggle');
            viewToggleBtn = document.getElementById('view-toggle');
            authModal = document.getElementById('auth-modal');
            authUsernameEl = document.getElementById('auth-username');
            authPasswordEl = document.getElementById('auth-password');
            authErrorMessageEl = document.getElementById('auth-error-message');
            adminTableContainer = document.getElementById('admin-table-body');

            // ã€æ–°å¢ã€‘åˆå§‹åŒ–ä¸­å¿ƒè·ç¦»æ˜ å°„
            CENTER_DISTANCE_MAP = calculateCenterDistanceMapping();

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            if (closeModal) {
                closeModal.addEventListener('click', window.closeVideoModal);
            }
            document.addEventListener('mousemove', updateMousePos);
            
            // å¯åŠ¨æ—¶é»˜è®¤æ¿€æ´»é¼ æ ‡
            isMouseActive = true; 

            // åˆå§‹åŒ– Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // setLogLevel('debug'); // è°ƒè¯•æ—¶æ‰“å¼€
                
                // 1. åŒ¿åç™»å½•
                await signInAnonymously(auth);
                console.log("Firebase anonymous auth successful.");

                // 2. åˆå§‹åŒ–é»˜è®¤ç½‘æ ¼æ•°æ® (å¦‚æœæ•°æ®åº“ä¸ºç©º)
                await initializeDefaultGridData();

                // 3. è®¾ç½®ç›‘å¬å™¨ (å†…å®¹ & ç½‘æ ¼)
                window.setupContentListener(db, appId);
                window.setupGridListener(db, appId);
                
                // 4. å¯åŠ¨åŠ¨ç”»
                startAnimationLoop();
                window.setAdminMode(false); // ç¡®ä¿æŒ‰é’®æ ·å¼æ­£ç¡®

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                // è¿è¡Œæœ¬åœ°å›é€€
                window.runLocalFallback();
            }
        });

    </script>
</head>
<body class="bg-black text-white overflow-hidden">

    <div id="grid-container" class="fixed inset-0 grid" style="transform: translate(-50%, -50%); left: 50%; top: 50%;">
        </div>

    <div id="top-content" class="fixed top-0 left-0 right-0 p-8 md:p-12 z-30 transition-all duration-300">
        
        <div id="content-display" class="">
            <h1 id="main-title" class="text-5xl md:text-8xl font-extrabold mb-4 transition-colors duration-500 hover:text-yellow-400 cursor-text" 
                data-style='{"size":"text-8xl", "weight":"font-extrabold", "color":"#FFFFFF", "spacing":"tracking-normal"}'>
                3D&Motion Creative&Production
            </h1>
            <p id="sub-text" class="text-lg md:text-2xl text-gray-400 transition-colors duration-500 hover:text-gray-200 cursor-text"
               data-style='{"size":"text-2xl", "weight":"font-normal", "color":"#9CA3AF", "spacing":"tracking-normal"}'>
                Powerd by REDesign
            </p>
        </div>

        <div id="edit-mode-container" class="hidden bg-gray-900 bg-opacity-80 backdrop-blur-md p-6 rounded-lg shadow-xl border border-gray-700">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                
                <div>
                    <div class="mb-4">
                        <label for="edit-web-title" class="block text-sm font-medium text-gray-300 mb-1">ç½‘ç«™æ ‡é¢˜ (Tab)</label>
                        <input type="text" id="edit-web-title" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                    <div class="mb-4">
                        <label for="edit-title" class="block text-sm font-medium text-gray-300 mb-1">ä¸»æ ‡é¢˜</label>
                        <input type="text" id="edit-title" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <div class="grid grid-cols-3 gap-2 mt-2">
                            <select id="edit-title-size" class="text-xs bg-gray-800 border-gray-700 text-white rounded px-2 py-1">
                                <option value="text-5xl">5xl</option><option value="text-6xl">6xl</option><option value="text-7xl">7xl</option><option value="text-8xl" selected>8xl</option><option value="text-9xl">9xl</option>
                            </select>
                            <select id="edit-title-weight" class="text-xs bg-gray-800 border-gray-700 text-white rounded px-2 py-1">
                                <option value="font-light">Light</option><option value="font-normal">Normal</option><option value="font-medium">Medium</option><option value="font-semibold">Semibold</option><option value="font-bold">Bold</option><option value="font-extrabold" selected>Extrabold</option>
                            </select>
                            <select id="edit-title-spacing" class="text-xs bg-gray-800 border-gray-700 text-white rounded px-2 py-1">
                                <option value="tracking-tighter">Tighter</option><option value="tracking-tight">Tight</option><option value="tracking-normal" selected>Normal</option><option value="tracking-wide">Wide</option><option value="tracking-wider">Wider</option>
                            </select>
                            <input type="color" id="edit-title-color" value="#FFFFFF" class="w-full h-8 cursor-pointer rounded border border-gray-700 col-span-3">
                        </div>
                    </div>
                    <div>
                        <label for="edit-subtitle" class="block text-sm font-medium text-gray-300 mb-1">å‰¯æ ‡é¢˜</Slabel>
                        <input type="text" id="edit-subtitle" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                         <div class="grid grid-cols-3 gap-2 mt-2">
                            <select id="edit-subtitle-size" class="text-xs bg-gray-800 border-gray-700 text-white rounded px-2 py-1">
                                <option value="text-sm">Small</option><option value="text-base">Base</option><option value="text-lg">Large</option><option value="text-xl">XL</option><option value="text-2xl" selected>2XL</option><option value="text-3xl">3XL</option>
                            </select>
                            <select id="edit-subtitle-weight" class="text-xs bg-gray-800 border-gray-700 text-white rounded px-2 py-1">
                                <option value="font-light">Light</option><option value="font-normal" selected>Normal</option><option value="font-medium">Medium</option><option value="font-semibold">Semibold</option><option value="font-bold">Bold</option>
                            </select>
                            <select id="edit-subtitle-spacing" class="text-xs bg-gray-800 border-gray-700 text-white rounded px-2 py-1">
                                <option value="tracking-tighter">Tighter</option><option value="tracking-tight">Tight</option><option value="tracking-normal" selected>Normal</option><option value="tracking-wide">Wide</option><option value="tracking-wider">Wider</option>
                            </select>
                             <input type="color" id="edit-subtitle-color" value="#9CA3AF" class="w-full h-8 cursor-pointer rounded border border-gray-700 col-span-3">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-yellow-400 mb-3">è§†è§‰å‚æ•°</h3>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                        <div>
                            <label for="edit-fisheye-radius" class="block text-xs font-medium text-gray-400">é±¼çœ¼åŠå¾„ (px)</label>
                            <input type="number" id="edit-fisheye-radius" value="300" class="w-full text-sm px-2 py-1 bg-gray-800 border border-gray-700 rounded text-white">
                        </div>
                         <div>
                            <label for="edit-decay-power" class="block text-xs font-medium text-gray-400">è¡°å‡æŒ‡æ•°</label>
                            <input type="number" id="edit-decay-power" value="2.0" step="0.1" class="w-full text-sm px-2 py-1 bg-gray-800 border border-gray-700 rounded text-white">
                        </div>
                        <div>
                            <label for="edit-min-scale" class="block text-xs font-medium text-gray-400">æœ€å°ç¼©æ”¾</label>
                            <input type="number" id="edit-min-scale" value="0.175" step="0.01" class="w-full text-sm px-2 py-1 bg-gray-800 border border-gray-700 rounded text-white">
                        </div>
                         <div>
                            <label for="edit-max-scale" class="block text-xs font-medium text-gray-400">æœ€å¤§ç¼©æ”¾</label>
                            <input type="number" id="edit-max-scale" value="3.0" step="0.1" class="w-full text-sm px-2 py-1 bg-gray-800 border border-gray-700 rounded text-white">
                        </div>
                        <div>
                            <label for="edit-parallax-smoothing" class="block text-xs font-medium text-gray-400">è§†å·®å¹³æ»‘ (0-1)</label>
                            <input type="number" id="edit-parallax-smoothing" value="0.2" step="0.05" min="0.01" max="1" class="w-full text-sm px-2 py-1 bg-gray-800 border border-gray-700 rounded text-white">
                        </div>
                        <div>
                            <label for="edit-grid-gap" class="block text-xs font-medium text-gray-400">ç½‘æ ¼é—´è· (px)</label>
                            <input type="number" id="edit-grid-gap" value="1" step="1" min="0" class="w-full text-sm px-2 py-1 bg-gray-800 border border-gray-700 rounded text-white">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-700">
                <button onclick="window.toggleEditMode(false)" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white font-medium">
                    å–æ¶ˆ
                </button>
                <button onclick="window.saveContent()" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-400 rounded text-black font-medium">
                    ä¿å­˜å†…å®¹
                </button>
            </div>
        </div>
    </div>

    <div id="admin-persistent-controls" class="fixed bottom-0 left-0 right-0 p-8 md:p-12 z-30 flex justify-between items-center">
        <button id="admin-toggle" onclick="window.handleAdminToggle()" class="text-sm text-gray-400 hover:text-white transition-colors">
            <span class="text-gray-400 hover:text-white transition-colors duration-300 mr-1">Â©</span> 2024 REDesign Studio
        </button>
        
        <div class="flex space-x-4">
             <button id="view-toggle" onclick="window.switchView(window.currentView === 'grid' ? 'table' : 'grid')" 
                    class="hidden px-4 py-2 bg-red-600 hover:bg-red-500 text-white text-sm font-medium rounded-lg shadow-lg transition-all">
                åˆ‡æ¢åˆ°åˆ—è¡¨ç¼–è¾‘
            </button>
            <button id="edit-main-toggle" onclick="window.toggleEditMode(true)" 
                    class="hidden px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium rounded-lg shadow-lg transition-all">
                ç¼–è¾‘ä¸»é¡µ
            </button>
        </div>
    </div>

    <div id="video-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-90 flex items-center justify-center">
        <div class="relative w-full max-w-5xl aspect-video p-4">
            <video id="video-player" class="w-full h-full" controls autoplay playsinline>
                <source src="" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <button id="close-modal-btn" class="absolute top-4 right-4 md:top-0 md:right-0 p-2 m-4 text-white text-4xl hover:text-gray-400 transition-colors">
                &times;
            </button>
        </div>
    </div>
    
    <div id="auth-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center">
        <div class="bg-gray-900 border border-gray-700 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white mb-6">ç®¡ç†å‘˜ç™»å½•</h2>
            <div class="space-y-4">
                <div>
                    <label for="auth-username" class="block text-sm font-medium text-gray-300 mb-1">ç”¨æˆ·å</label>
                    <input type="text" id="auth-username" value="admin" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-300 mb-1">å¯†ç </label>
                    <input type="password" id="auth-password" autocomplete="current-password" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="auth-error-message" class="hidden text-sm text-red-400">
                    ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚
                </div>
            </div>
            <div class="flex justify-between items-center mt-8">
                <button onclick="window.closeAuthModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white font-medium">
                    å–æ¶ˆ
                </button>
                <button onclick="window.handleAdminLogin()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-medium">
                    ç™»å½•
                </button>
            </div>
        </div>
    </div>
    
    <div id="admin-table-view" class="hidden fixed inset-0 z-40 bg-black overflow-y-auto pt-40 pb-20 px-12">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-white mb-6">ç½‘æ ¼å†…å®¹ç®¡ç† (æŒ‰ä¸­å¿ƒè·ç¦»æ’åº)</h2>
            <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl overflow-hidden">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-900">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ä½ç½®</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ç¼©ç•¥å›¾</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">å›¾ç‰‡ URL</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">è§†é¢‘ URL</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">èƒŒæ™¯è‰²</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body" class="divide-y divide-gray-700">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

</body>
</html>
